<!DOCTYPE html>
<html>
<head>
  <title>Simple AR Card Popup</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="libs/three.min.js"></script>
  <script src="libs/mindar-image-three.prod.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      height: 100%;
      font-family: sans-serif;
    }
    #ar-container {
      width: 100vw;
      height: 100vh;
      position: relative;
    }
    #card-popup {
      position: absolute;
      top: 50%;
      left: 50%;
      width: 300px;
      height: 420px;
      margin-left: -150px;
      margin-top: -210px;
      background-image: url('layers/card-bg.png');
      background-size: contain;
      background-repeat: no-repeat;
      cursor: grab;
      display: none;
      touch-action: none;
      z-index: 10;
      transform-style: preserve-3d;
      transform-origin: center;
      transform: perspective(1000px) rotateX(0deg) rotateY(0deg);
    }
  </style>
</head>
<body>
  <div id="ar-container"></div>
  <div id="card-popup"></div>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      const mindarThree = new window.MINDAR.IMAGE.MindARThree({
        container: document.querySelector("#ar-container"),
        imageTargetSrc: "./targets.mind",
        maxTrack: 1,
        filterMinCF: 0.0001,
        filterBeta: 0.001
      });

      const { renderer, scene, camera } = mindarThree;

      const anchor = mindarThree.addAnchor(0);
      let hasDetected = false;

      // Show popup on first detection
      anchor.onTargetFound = () => {
        if (hasDetected) return;
        hasDetected = true;

        document.getElementById("card-popup").style.display = "block";
        document.querySelector(".mindar-ui-overlay")?.style.display = "none";
        anchor.stop(); // Stop tracking target but keep camera
      };

      // Start camera and tracking
      await mindarThree.start();

      renderer.setAnimationLoop(() => {
        renderer.render(scene, camera);
      });

      // Drag-rotate logic
      const card = document.getElementById('card-popup');
      let isDragging = false;
      let rotationX = 0;
      let rotationY = 0;

      card.addEventListener('pointerdown', (e) => {
      isDragging = true;
      lastX = e.clientX;
      lastY = e.clientY;
      card.style.cursor = 'grabbing';
    });
    
    window.addEventListener('pointerup', () => {
      isDragging = false;
      card.style.cursor = 'grab';
    });
    
    window.addEventListener('pointermove', (e) => {
      if (!isDragging) return;
      const deltaX = e.clientX - lastX;
      const deltaY = e.clientY - lastY;
    
      rotationY += deltaX * 0.3; // horizontal drag rotates Y axis
      rotationX -= deltaY * 0.3; // vertical drag rotates X axis
    
      card.style.transform = `perspective(1000px) translate(-50%, -50%) rotateX(${rotationX}deg) rotateY(${rotationY}deg)`;
    
      lastX = e.clientX;
      lastY = e.clientY;
      });
    });
  </script>
</body>
</html>
